<html><style>
BODY,TR
    {color: #303030;font-size: 12px;font-family:sans-serif}
BODY,TR.bgrnd
    {background-color: #eeeeee;}
TR,TR.work
    {background-color: #CCCCCC;}
TR.rmk
    {background-color: #888888;}
TR.zebra0
    {background-color: #e0e0e0;}
TR.zebra1
    {background-color: #f0f0f0;}
TR.zebra2
    {background-color: #FFe0e0;}
TR.zebra3
    {background-color: #FFe7e7;}
TR.diff
    {background-color: #e0FFe0;}
TR.diff1
    {background-color: #e0e0FF;}
TR.diff2
    {background-color: #FFe0e0;}
A
    {color: #000000; text-decoration: none;}
A.undr,A:hover
    {text-decoration: underline;}
TH
    {font-size: 12px;text-align:left;}
</style><body><pre>TaskID: 536882026_461<br>Name  : Bitcoin gateway integration 4.6.1<br>URL   : https://secure.qtmsoft.com/customer.php?target=task_info&subject=536882026_461<br><br></pre>
<script>function showme(a) {el = document.getElementById(a);el.style.display=(el.style.display ? "" : "none");}</script>
<table border=0 width=100% cellpadding=2 cellspacing=0><tr class=rmk><td>
<table border=0 width=100% cellpadding=3 cellspacing=0>
<tr class=zebra0><td width=1%>[+]</td><td width=1% nowrap>[<a href="javascript:showme('5a53fd0f');">diff</a>]</td><td width=1% nowrap>payment/ps_coinbase.php</td><td></td></tr>
<tr style="display: none;" id="5a53fd0f"><td colspan=4><table border=0 cellpadding=2 cellspacing=0 width=100%>
<tr class=diff1><td><pre>-- payment/ps_coinbase.php</td></tr>
<tr class=diff2><td><pre>++ payment/ps_coinbase.php</td></tr>
<tr class=diff><td><pre>@@ -0,0 +1,104 @@</td></tr>
<tr class=diff2><td><pre>&lt;?php</td></tr>
<tr class=diff2><td><pre>/* vim: set ts=4 sw=4 sts=4 et: */</td></tr>
<tr class=diff2><td><pre>/*****************************************************************************\</td></tr>
<tr class=diff2><td><pre>+-----------------------------------------------------------------------------+</td></tr>
<tr class=diff2><td><pre>| X-Cart Software license agreement                                           |</td></tr>
<tr class=diff2><td><pre>| Copyright (c) 2001-2014 Qualiteam software Ltd &lt;info@x-cart.com&gt;            |</td></tr>
<tr class=diff2><td><pre>| All rights reserved.                                                        |</td></tr>
<tr class=diff2><td><pre>+-----------------------------------------------------------------------------+</td></tr>
<tr class=diff2><td><pre>| PLEASE READ  THE FULL TEXT OF SOFTWARE LICENSE AGREEMENT IN THE &quot;COPYRIGHT&quot; |</td></tr>
<tr class=diff2><td><pre>| FILE PROVIDED WITH THIS DISTRIBUTION. THE AGREEMENT TEXT IS ALSO AVAILABLE  |</td></tr>
<tr class=diff2><td><pre>| AT THE FOLLOWING URL: http://www.x-cart.com/license.php                     |</td></tr>
<tr class=diff2><td><pre>|                                                                             |</td></tr>
<tr class=diff2><td><pre>| THIS AGREEMENT EXPRESSES THE TERMS AND CONDITIONS ON WHICH YOU MAY USE THIS |</td></tr>
<tr class=diff2><td><pre>| SOFTWARE PROGRAM AND ASSOCIATED DOCUMENTATION THAT QUALITEAM SOFTWARE LTD   |</td></tr>
<tr class=diff2><td><pre>| (hereinafter referred to as &quot;THE AUTHOR&quot;) OF REPUBLIC OF CYPRUS IS          |</td></tr>
<tr class=diff2><td><pre>| FURNISHING OR MAKING AVAILABLE TO YOU WITH THIS AGREEMENT (COLLECTIVELY,    |</td></tr>
<tr class=diff2><td><pre>| THE &quot;SOFTWARE&quot;). PLEASE REVIEW THE FOLLOWING TERMS AND CONDITIONS OF THIS   |</td></tr>
<tr class=diff2><td><pre>| LICENSE AGREEMENT CAREFULLY BEFORE INSTALLING OR USING THE SOFTWARE. BY     |</td></tr>
<tr class=diff2><td><pre>| INSTALLING, COPYING OR OTHERWISE USING THE SOFTWARE, YOU AND YOUR COMPANY   |</td></tr>
<tr class=diff2><td><pre>| (COLLECTIVELY, &quot;YOU&quot;) ARE ACCEPTING AND AGREEING TO THE TERMS OF THIS       |</td></tr>
<tr class=diff2><td><pre>| LICENSE AGREEMENT. IF YOU ARE NOT WILLING TO BE BOUND BY THIS AGREEMENT, DO |</td></tr>
<tr class=diff2><td><pre>| NOT INSTALL OR USE THE SOFTWARE. VARIOUS COPYRIGHTS AND OTHER INTELLECTUAL  |</td></tr>
<tr class=diff2><td><pre>| PROPERTY RIGHTS PROTECT THE SOFTWARE. THIS AGREEMENT IS A LICENSE AGREEMENT |</td></tr>
<tr class=diff2><td><pre>| THAT GIVES YOU LIMITED RIGHTS TO USE THE SOFTWARE AND NOT AN AGREEMENT FOR  |</td></tr>
<tr class=diff2><td><pre>| SALE OR FOR TRANSFER OF TITLE. THE AUTHOR RETAINS ALL RIGHTS NOT EXPRESSLY  |</td></tr>
<tr class=diff2><td><pre>| GRANTED BY THIS AGREEMENT.                                                  |</td></tr>
<tr class=diff2><td><pre>+-----------------------------------------------------------------------------+</td></tr>
<tr class=diff2><td><pre>\*****************************************************************************/</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>/**</td></tr>
<tr class=diff2><td><pre> * Coinbase payment</td></tr>
<tr class=diff2><td><pre> *</td></tr>
<tr class=diff2><td><pre> * @category   X-Cart</td></tr>
<tr class=diff2><td><pre> * @package    X-Cart</td></tr>
<tr class=diff2><td><pre> * @subpackage Payment interface</td></tr>
<tr class=diff2><td><pre> * @author     Ruslan R. Fazlyev &lt;rrf@x-cart.com&gt;</td></tr>
<tr class=diff2><td><pre> * @copyright  Copyright (c) 2001-2014 Qualiteam software Ltd &lt;info@x-cart.com&gt;</td></tr>
<tr class=diff2><td><pre> * @license    http://www.x-cart.com/license.php X-Cart license agreement</td></tr>
<tr class=diff2><td><pre> * @version    536d95e589c24076e32b35967cd3b39d91407507, v1 (xcart_4_6_1), 2014-01-20 14:19:03, ps_coinbase.php, kolbasa</td></tr>
<tr class=diff2><td><pre> * @link       http://www.x-cart.com/</td></tr>
<tr class=diff2><td><pre> * @see        ____file_see____</td></tr>
<tr class=diff2><td><pre> */</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>require './auth.php';        </td></tr>
<tr class=diff2><td><pre>require $xcart_dir . '/payment/Coinbase/Coinbase.php';</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>$api_key = $module_params['param01'];</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>if ($_SERVER['REQUEST_METHOD'] == 'GET' &amp;&amp; isset($_GET['mode']) &amp;&amp; $_GET['mode'] == 'callback' &amp;&amp; isset($_GET['orderids']) &amp;&amp; $_GET['orderids']) {</td></tr>
<tr class=diff2><td><pre>    $response = $_GET['order'];</td></tr>
<tr class=diff2><td><pre>    $orderids = $_GET['orderids'];</td></tr>
<tr class=diff2><td><pre>    $bill_output['sessid'] = func_query_first_cell(&quot;SELECT sessid FROM $sql_tbl[cc_pp3_data] WHERE ref='&quot; . $orderids . &quot;'&quot;);</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>    if (!empty($response) &amp;&amp; $response['status'] == 'completed') {</td></tr>
<tr class=diff2><td><pre>        $bill_output['code'] = 1;                        </td></tr>
<tr class=diff2><td><pre>        $bill_output['billmes'] = 'Paid';</td></tr>
<tr class=diff2><td><pre>    } else {</td></tr>
<tr class=diff2><td><pre>        $bill_output['code'] = 2;</td></tr>
<tr class=diff2><td><pre>        $bill_output['billmes'] = $response['cancellation_reason'];</td></tr>
<tr class=diff2><td><pre>    }</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>    $skey = $_GET['orderids'];</td></tr>
<tr class=diff2><td><pre>    require $xcart_dir . '/payment/payment_ccmid.php';</td></tr>
<tr class=diff2><td><pre>    require $xcart_dir . '/payment/payment_ccwebset.php';</td></tr>
<tr class=diff2><td><pre>        </td></tr>
<tr class=diff2><td><pre>} elseif (isset($_GET['mode']) &amp;&amp; $_GET['mode'] == 'complete' &amp;&amp; isset($_GET['orderids'])) {</td></tr>
<tr class=diff2><td><pre>    $weblink = 2;</td></tr>
<tr class=diff2><td><pre>    $skey = $_GET['orderids'];</td></tr>
<tr class=diff2><td><pre>    require($xcart_dir . '/payment/payment_ccview.php');</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>} elseif (isset($_GET['mode']) &amp;&amp; $_GET['mode'] == 'cancel' &amp;&amp; isset($_GET['orderids'])) {</td></tr>
<tr class=diff2><td><pre>    $bill_output['sessid'] = func_query_first_cell(&quot;SELECT sessid FROM $sql_tbl[cc_pp3_data] WHERE ref='&quot; . $_GET['orderids'] . &quot;'&quot;);</td></tr>
<tr class=diff2><td><pre>    $bill_output['code'] = 2;</td></tr>
<tr class=diff2><td><pre>    $bill_output['billmes'] = 'Canceled';</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>    $skey = $_GET['orderids'];</td></tr>
<tr class=diff2><td><pre>    require($xcart_dir . '/payment/payment_ccend.php');</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>} else {</td></tr>
<tr class=diff2><td><pre>    if (!defined('XCART_START')) { header('Location: ../'); die('Access denied'); }        </td></tr>
<tr class=diff2><td><pre>        </td></tr>
<tr class=diff2><td><pre>    $_orderids = join('-', $secure_oid);</td></tr>
<tr class=diff2><td><pre>    if (!$duplicate) {</td></tr>
<tr class=diff2><td><pre>        db_query(&quot;REPLACE INTO $sql_tbl[cc_pp3_data] (ref, sessid, trstat) VALUES ('&quot; . $_orderids . &quot;', '&quot; . $XCARTSESSID . &quot;', 'GO|&quot; . implode('|', $secure_oid) . &quot;')&quot;);</td></tr>
<tr class=diff2><td><pre>    }</td></tr>
<tr class=diff2><td><pre>        </td></tr>
<tr class=diff2><td><pre>    $coinbase = new Coinbase($api_key);</td></tr>
<tr class=diff2><td><pre>    $response = $coinbase-&gt;createButton('Order #' . $_orderids, &quot;$cart[total_cost]&quot;, 'USD', '', array(</td></tr>
<tr class=diff2><td><pre>        'callback_url' =&gt; $current_location . '/payment/ps_coinbase.php?mode=callback&amp;orderids=' . $_orderids,</td></tr>
<tr class=diff2><td><pre>        'success_url'  =&gt; $current_location . '/payment/ps_coinbase.php?mode=complete&amp;orderids=' . $_orderids,</td></tr>
<tr class=diff2><td><pre>        'cancel_url'   =&gt; $current_location . '/payment/ps_coinbase.php?mode=cancel&amp;orderids=' . $_orderids</td></tr>
<tr class=diff2><td><pre>    ));</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>    if ($response-&gt;button-&gt;code) {</td></tr>
<tr class=diff2><td><pre>        func_html_location('https://coinbase.com/checkouts/' . $response-&gt;button-&gt;code);</td></tr>
<tr class=diff2><td><pre>        exit;</td></tr>
<tr class=diff2><td><pre>    } else {</td></tr>
<tr class=diff2><td><pre>        x_log_add('debug_coinbase', 'error');</td></tr>
<tr class=diff2><td><pre>    }</td></tr>
<tr class=diff2><td><pre>}</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>exit;</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>?&gt;</td></tr>
</table>
</td></tr>
<tr class=zebra1><td width=1%>[+]</td><td width=1% nowrap>[<a href="javascript:showme('5fe6ef79');">diff</a>]</td><td width=1% nowrap>skin/common_files/payments/ps_coinbase.tpl</td><td></td></tr>
<tr style="display: none;" id="5fe6ef79"><td colspan=4><table border=0 cellpadding=2 cellspacing=0 width=100%>
<tr class=diff1><td><pre>-- skin/common_files/payments/ps_coinbase.tpl</td></tr>
<tr class=diff2><td><pre>++ skin/common_files/payments/ps_coinbase.tpl</td></tr>
<tr class=diff><td><pre>@@ -0,0 +1,25 @@</td></tr>
<tr class=diff2><td><pre>{*</td></tr>
<tr class=diff2><td><pre>$Id: ps_coinbase.tpl,v 1 2014/01/16 20:04:51 kolbasa Exp $</td></tr>
<tr class=diff2><td><pre>vim: set ts=2 sw=2 sts=2 et:</td></tr>
<tr class=diff2><td><pre>*}</td></tr>
<tr class=diff2><td><pre>&lt;h1&gt;Coinbase&lt;/h1&gt;</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>{$lng.txt_cc_configure_top_text}</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>&lt;br /&gt;&lt;br /&gt;</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>{capture name=dialog}</td></tr>
<tr class=diff2><td><pre>&lt;form action=&quot;cc_processing.php?cc_processor={$smarty.get.cc_processor|escape:&quot;url&quot;}&quot; method=&quot;post&quot;&gt;</td></tr>
<tr class=diff2><td><pre>  &lt;table cellspacing=&quot;10&quot;&gt;</td></tr>
<tr class=diff2><td><pre>    &lt;tr&gt;</td></tr>
<tr class=diff2><td><pre>      &lt;td&gt;{$lng.lbl_coinbase_api_key}:&lt;/td&gt;</td></tr>
<tr class=diff2><td><pre>      &lt;td&gt;&lt;input type=&quot;text&quot; name=&quot;param01&quot; size=&quot;64&quot; value=&quot;{$module_data.param01|escape}&quot; /&gt;&lt;/td&gt;</td></tr>
<tr class=diff2><td><pre>    &lt;/tr&gt;</td></tr>
<tr class=diff2><td><pre>  &lt;/table&gt;</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>  &lt;br /&gt;&lt;br /&gt;</td></tr>
<tr class=diff2><td><pre>  &lt;input type=&quot;submit&quot; value=&quot;{$lng.lbl_update|strip_tags:false|escape}&quot; /&gt;</td></tr>
<tr class=diff2><td><pre>&lt;/form&gt;</td></tr>
<tr class=diff2><td><pre>{/capture}</td></tr>
<tr class=diff2><td><pre> </td></tr>
<tr class=diff2><td><pre>{include file=&quot;dialog.tpl&quot; title=$lng.lbl_cc_settings content=$smarty.capture.dialog extra='width=&quot;100%&quot;'}</td></tr>
</table>
</td></tr>
<tr class=zebra0><td width=1%>&nbsp;</td><td width=1% nowrap>[<a href="javascript:showme('sql_ch');">diff</a>]</td><td width=1% nowrap>SQL changes</td><td>&nbsp;</td></tr>
<tr style="display: none;" id="sql_ch" class=diff><td colspan=4><pre>INSERT INTO xcart_languages SET code='en', name='lbl_coinbase_api_key', value='API key', topic='Labels';</td></tr>
</table>
</td></tr></table>
</html>
